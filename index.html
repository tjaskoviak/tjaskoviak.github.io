<script src="https://d3js.org/d3.v4.min.js"></script>


<style>
rect {
	color: black;
}
</style>

<body>
  <h1>  </h1>
  <div id="exp">
  	<svg width="720" height="500" display="none" id="chart">
  	</svg>
  	<form id="mainInput" method="post">
  		<p id="mainText">In this experiment, you are asked to judge <br>what is the percent of a smaller value to a larger value in several charts. <br>We won't record any other information expect for your answers. <br>Click "Start" to begin.</p>
  		<br>
  		<input type="button" id="sub" value="Start" onClick="startExperiment()">
  	</form>
  </div>
</body>

<script>
  console.log(d3); // test if d3 is loaded

  var exp = document.getElementById('exp');
  var chart = document.getElementById('chart');
  var results = [];
  var a = 20
  	, b = 20
  	, c = 20
  var partID = '1';
  var currChart = '';
  var currDiff = 0;

  // set the dimensions and margins of the graph
	var margin = {top: 20, right: 20, bottom: 30, left: 40},
	    width = 720 - margin.left - margin.right,
	    height = 500 - margin.top - margin.bottom;

	// set the ranges
	var x = d3.scaleBand()
	          .range([0, width])
	          .padding(0.1);
	var y = d3.scaleLinear()
	          .range([height, 0]);
	          
	// append the svg object to the body of the page
	// append a 'group' element to 'svg'
	// moves the 'group' element to the top left margin
	var svg = d3.select("svg")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	  .append("g")
	    .attr("transform", 
	          "translate(" + margin.left + "," + margin.top + ")");


  function startExperiment() {
  	console.log("Started");

  	chart.setAttribute('display', "block");

  	var fom = document.getElementById('mainInput');
  	var text = document.getElementById('mainText');
  	text.innerHTML = "The two values are marked with outlines. <br>What do you think the percent of the smaller value is to the larger value? <br>Please put your answer below. <br><br>e.g. If you think the smaller one is exactly hald of the bigger one then you would input '50'";
  	var sub = document.getElementById('sub');
  	sub.setAttribute('onClick', "recordResult(this.form)");
  	sub.setAttribute('value', "Submit");
  	
  	var inputBox = document.createElement("input");
  	inputBox.setAttribute('type', "text");
  	inputBox.setAttribute('id', "result");
  	inputBox.setAttribute('name', "recordedVal");
  	fom.insertBefore(inputBox, sub);

  	nextTrial();
  }

  function nextTrial() {
  	console.log(a, b, c);
  	console.log(currChart);

  	if(currChart === 'a') {
  		a -= 1;
  	} else if(currChart === 'b') {
  		b -= 1;
  	} else if(currChart === 'c') {
  		c -= 1;
  	}
  	console.log(a, b, c);

  	var trialsLeft = a + b + c;
  	if(trialsLeft === 0) {
  		endExperiment();
  		return;
  	}
  	var chartNum = Math.floor(Math.random() * trialsLeft);
  	if(chartNum < a) {
  		currChart = 'a';
		generateChartA();
  	} else if(chartNum < a + b) {
  		currChart = 'b';
  		generateChartB();
  	} else {
  		currChart = 'c';
  		generateChartC();
  	}
  	console.log(chartNum);
  	console.log(currChart);

  	console.log(results);
  }

  function endExperiment() {
  	console.log("End of Experiment")
  	console.log(a, b, c);
  	console.log(results);
  	document.getElementById("mainInput").remove();
  	var text = document.getElementById('exp');
  	text.innerHTML = results;
  }

  function recordResult() {

  	var result = document.getElementById("result").value;
  	results.push(partID + ',' + currChart + ',' + currDiff + ',' + result + ';');

  	nextTrial();
  }

  function getNewData() {
  	var newDataset = [];

  	for(i = 0; i < 10; i++) {
  		newDataset[i] = Math.floor(Math.random() * 100) + 1;
  	}
  	console.log(newDataset);
  	return newDataset;
  }

  function generateChartA() {
  	var dataSet = getNewData();
  	console.log("GenerateChart");
  	var rects = svg.selectAll('rect')
  	rects.remove();

  	if(dataSet[4] > dataSet[5]) {
  		currDiff = dataSet[5] / dataSet[4]
  	}
  	else {
  		currDiff = dataSet[4] / dataSet[5]
  	}

  	svg.selectAll('.bar')
  			.data(dataSet)
  		.enter().append('rect')
  			.classed('bar', true)
  			.attr('x', function(d, i) {
  				return i * 30
  			})
  			.attr('y', function(d, i) {
  				return 400 - d*3
  			})
  			.style('fill',  "ffffff")
  			.style('stroke', "000000")
  			.style('stroke-width', function(d, i) {
  				if(i === 4 || i === 5) {
  					return 2
  				} else {
  					return 1
  				}
  			})
  			.attr('height', function(d, i) {
  				return d * 3
  			})
  			.attr('width', 26);

  }

  function generateChartB() {
  	var dataSet = getNewData();
  	console.log("GenerateChart");
  	var rects = svg.selectAll('rect')
  	rects.remove();

  	if(dataSet[4] > dataSet[5]) {
  		currDiff = dataSet[5] / dataSet[4]
  	}
  	else {
  		currDiff = dataSet[4] / dataSet[5]
  	}

  	svg.selectAll('.bar')
  			.data(dataSet)
  		.enter().append('rect')
  			.classed('bar', true)
  			.attr('x', function(d, i) {
  				return i * 30
  			})
  			.attr('y', "50")
  			.style('fill',  "ffffff")
  			.style('stroke', "000000")
  			.style('stroke-width', function(d, i) {
  				if(i === 4 || i === 5) {
  					return 2
  				} else {
  					return 1
  				}
  			})
  			.attr('height', function(d, i) {
  				return d * 3
  			})
  			.attr('width', 26);

  }

  function generateChartC() {
  	var dataSet = getNewData();
  	console.log("GenerateChart");
  	var rects = svg.selectAll('rect')
  	rects.remove();

  	if(dataSet[4] > dataSet[5]) {
  		currDiff = dataSet[5] / dataSet[4]
  	}
  	else {
  		currDiff = dataSet[4] / dataSet[5]
  	}

  	svg.selectAll('.bar')
  			.data(dataSet)
  		.enter().append('rect')
  			.classed('bar', true)
  			.attr('x', "0")
  			.attr('y', function(d, i) {
  				return i * 30 + 50
  			})
  			.style('fill',  "ffffff")
  			.style('stroke', "000000")
  			.style('stroke-width', function(d, i) {
  				if(i === 4 || i === 5) {
  					return 2
  				} else {
  					return 1
  				}
  			})
  			.attr('height', 26)
  			.attr('width', function(d, i) {
  				return d * 3
  			});

  }
</script>
